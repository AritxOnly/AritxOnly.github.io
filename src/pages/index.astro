---
import Layout from '~/layouts/Layout.astro'
import { getSortedPosts } from '~/utils'
import { getCollection, render } from 'astro:content'
import PostPreview from '~/components/PostPreview.astro'
import Pagination from '~/components/Pagination.astro'
import BlockHeader from '~/components/BlockHeader.astro'
import HomeBanner from '~/components/HomeBanner.astro'
import siteConfig from '~/site.config'
import TagsSection from '~/components/TagsSection.astro'
import SeriesSection from '~/components/SeriesSection.astro'
import ChevronsRightIcon from '~/icons/chevrons-right.svg'
import apps from '~/data/apps.json'

const home = await getCollection('home')
let HomeContent
let homeAvatarImage
let homeGithubCalendar
if (home.length > 0) {
  const homeEntry = home[0]
  const { Content } = await render(homeEntry)
  HomeContent = Content
  homeAvatarImage = homeEntry.data.avatarImage
  homeGithubCalendar = homeEntry.data.githubCalendar
}
const sortedPosts = await getSortedPosts()
const postsHaveTags = sortedPosts.some(
  (post) => post.data.tags && post.data.tags.length > 0,
)

const postsHaveSeries = sortedPosts.some((post) => post.data.series)
---

<Layout>
  {
    HomeContent && (
      <HomeBanner avatarImage={homeAvatarImage} githubCalendar={homeGithubCalendar}>
        <Fragment slot="title">
          <h1>Yo! 欢迎来到我的个人小站 👋</h1>
        </Fragment>

        <HomeContent />
      </HomeBanner>
    )
  }

<section>
  <BlockHeader>我的项目</BlockHeader>

  <div class="grid gap-4 sm:grid-cols-2 mt-4">
    {apps.slice(0, 2).map((app) => (
      <a
        href={app.url}
        target="_blank"
        rel="noopener"
        class="group flex h-full flex-col justify-between rounded-2xl border border-accent p-4 hover:bg-accent/5 transition"
        aria-label={`查看 ${app.name}`}
      >
        <div>
          {app.images && app.images.length > 0 && (
            <img
              src={app.images[0]}
              alt={app.name}
              loading="lazy"
              class="mb-3 aspect-video w-full rounded-lg object-cover"
            />
          )}

          <h3 class="text-lg font-semibold">{app.name}</h3>
          <p class="mt-1 text-[var(--ec-foreground-muted)]">
            {app.short}
          </p>
        </div>

        <div class="mt-3 flex items-center gap-1 text-accent opacity-90 group-hover:opacity-100">
          <span>了解更多</span>
          <ChevronsRightIcon class="inline size-4" />
        </div>
      </a>
    ))}
    </div>
  </section>

  {
    postsHaveSeries && (
      <section>
        <BlockHeader>合集</BlockHeader>
        <SeriesSection posts={sortedPosts} />
      </section>
    )
  }
  {
    postsHaveTags && (
      <section>
        <BlockHeader>标签</BlockHeader>
        <TagsSection posts={sortedPosts} />
      </section>
    )
  }
  {
    sortedPosts.length > 0 && (
      <section>
        <BlockHeader>最近博客</BlockHeader>
        {sortedPosts
          .reverse()
          .slice(0, Math.floor(siteConfig.pageSize / 2))
          .map((post) => (
            <PostPreview post={post} />
          ))}
        <Pagination nextLink="/posts" nextText="博客列表" />
      </section>
    )
  }
</Layout>

<style is:global>
  a.heading-anchor {
    display: none !important;
  }
</style>
